function in_array(e, b, a) {
    if (a) {
        function d(g, f) {
            return g === f
        }
    } else {
        function d(g, f) {
            return g == f
        }
    }
    for (var c in b) {
        if (d(b[c], e)) {
            return true
        }
    }
    return false
}

function array_search(d, c, a) {
    var a = !!a;
    for (var b in c) {
        if ((a && c[b] === d) || (!a && c[b] == d)) {
            return true
        }
    }
    return false
}
if (jQuery) {
    (function(a) {
        var b = "skins/" + a("#val_skin_folder").text() + "/images/";
        if (a("#val_admin_folder").length) {
            b = a("#val_admin_folder").text() + "/" + b
        } else {
            if (a("#val_store_url").length) {
                b = a("#val_store_url").text() + "/" + b
            }
        }
        if (a("#val_skin_common_images").length) {
            b = b + a("#val_skin_common_images").text() + "/"
        }
        a.extend(a.fn, {
            fileTree: function(d, c) {
                if (!d) {
                    var d = {}
                }
                if (!c) {
                    var c = function(e) {
                        return
                    }
                }
                if(typeof d.root == 'undefined') {
                    d.root = "/"
                }
                if(typeof d.name == 'undefined') {
                    d.name = "image"
                }
                if(typeof d.group == 'undefined') {
                    d.group = 1
                }
                if(typeof d.script == 'undefined') {
                    d.script = a("#val_admin_file").text()
                }
                if(typeof d.unique == 'undefined') {
                    d.unique = (a(this).hasClass("unique")) ? true : false
                }
                a(this).each(function() {
                    function f(h, g) {
                        a(h).addClass("wait");
                        a(".filetree.start").remove();
                        if (a(h).children("ul").length >= 1) {
                            a(h).removeClass("wait").children("ul").slideDown()
                        } else {
                            a.ajax({
                                complete: function(i, j) {
                                    a(".wait").removeClass("wait")
                                },
                                dataType: "json",
                                global: false
                            });
                            
                            var product_id = '';

                            if($("#val_product_id").length) {
                                product_id = $("div#val_product_id").text();
                            }

                            a.getJSON(d.script, {
                                _g: "xml",
                                type: "files",
                                q: "list",
                                dir: g,
                                group: d.group,
                                product_id: product_id
                            }, function(j) {
                                a(h).find(".start").html("");
                                var i = document.createElement("ul");
                                a(i).addClass("filetree");

                                if(d.group == '1' && d.root == g) {
                                    var top_level = document.createElement("li");
                                    a(top_level).addClass("directory collapsed");
                                    var top_level_a = document.createElement("a");
                                    a(top_level_a).attr({
                                                    href: "#",
                                                    rel: '/'
                                                }).text('./')
                                    a(i).append(top_level);
                                    a(top_level).append(top_level_a);
                                }
                                
                                a.each(j, function(p, r) {
                                    var k = document.createElement("li");
                                    var m = document.createElement("a");
                                    switch (r.type) {
                                        case "directory":
                                            a(k).addClass("directory collapsed");
                                            a(m).attr({
                                                href: "#",
                                                rel: r.path
                                            }).text(r.name);
                                            break;
                                        case "file":
                                            var q = document.createElement("span");
                                            var o = document.createElement("img");
                                            var l = "0";
                                            var n = r.assigned;

                                            if(r.form_field && r.assigned>0) {
                                                var ff = document.createElement("input");
                                                a(ff).addClass("toggle").attr({
                                                    type: "hidden",
                                                    id: 'image_'+r.id,
                                                    rel: r.id,
                                                    name: 'image['+r.id+']',
                                                    value: n
                                                });
                                                a(q).append(ff);
                                            }

                                            a(q).addClass("actions");
                                            a(o).addClass("imgtoggle").data({
                                                id: d.name + "_" + r.id,
                                                rel: r.id,
                                                name: d.name + "[" + r.id + "]",
                                                value: n
                                            });
                                            switch (n) {
                                                case "2":
                                                    l = "star";
                                                    break;
                                                default:
                                                    l = n
                                            }
                                            o.src = b + l + ".png";
                                            a(o).attr({
                                                rel: "#" + d.name + "_" + r.id
                                            }).addClass("checkbox");
                                            if (d.unique) {
                                                a(o).addClass("unique")
                                            }

                                            a(q).append(o);
                                            a(k).append(q).addClass("file");
                                            a(m).attr({
                                                href: r.path + r.name,
                                                rel: r.path,
                                                title: r.description
                                            }).text(r.file);
                                            if (r.mime.match(/^image/)) {
                                                a(k).addClass("image");
                                                a(m).bind("click", function() {
                                                    a.fn.colorbox({
                                                        href: a(m).attr("href"),
                                                        open: true
                                                    });
                                                    return false
                                                })
                                            }
                                            break
                                    }
                                    a(k).append(m);
                                    a(i).append(k)
                                });

                                if (d.root == g) {
                                    a(h).find("ul:hidden").show()
                                } else {
                                    a(h).find("ul:hidden").slideDown("slow")
                                }
                                if(d.group == '1' && d.root == g) {
                                    var show_all_images = true;
                                    var disp_tog = document.createElement("div");
                                    a(disp_tog).attr('id', 'assigned_toggle');
                                    a(disp_tog).addClass('button');
                                    show_all_images = images_toggle(disp_tog, h, show_all_images); 
                                    a(disp_tog).click(function() {
                                        show_all_images = images_toggle(disp_tog, h, show_all_images);   
                                    });
                                    a(h).append(disp_tog);
                                }
                                a(h).append(i).removeClass("wait");
                                
                                if(!$('#fm-actions').length) {
                                    var actions = document.createElement("div");
                                    a(actions).attr('id', 'fm-actions');
                                    a(h).after(actions);

                                    var create_folder = document.createElement("div");
                                    var create_folder_input = document.createElement("input");
                                    var create_folder_btn = document.createElement("button");
                                    a(create_folder_input).attr({
                                                type: 'text',
                                                id: 'fm-icf',
                                                value: ''
                                            });
                                    a(create_folder_btn).attr({
                                                type: 'button',
                                                id: 'fm-bcf' 
                                            }).text('Go');

                                    a(create_folder).addClass('fm-create_folder').text('Create Folder:');
                                    a(create_folder).append(create_folder_input).append(create_folder_btn);

                                    var refresh = document.createElement("div");
                                    var refresh_i = document.createElement("i");
                                    
                                    a(refresh).addClass('fm-refresh');
                                    a(refresh).text('Refresh File List');
                                    a(refresh_i).addClass('fa fa-refresh');
                                    a(refresh).prepend(refresh_i);

                                    var selected_folder = document.createElement("div");
                                    var selected_folder_val = document.createElement("span");
                                    a(selected_folder_val).attr('id', 'val_subdir');

                                    a(selected_folder).text('Upload Destination: /');
                                    a(selected_folder).append(selected_folder_val);

                                    a(actions).append(create_folder);
                                    a(actions).append(selected_folder);
                                    a(actions).append(refresh);
                                }

                                e(h);
                                a(".loading").hide();
                                
                                var master_image = a("#master_image_preview").attr("src");
                                a("li.image" )
                                  .mouseover(function() {
                                    a(".master_image span").text("Preview");
                                    if (a("#master_image_preview").exists()) {
                                        a("#master_image_preview").hide();
                                        var i = a(this).closest(".image").find("a").attr("href");
                                        a("#preview_image img").attr("src", i);
                                        a("#preview_image img").show();
                                    }
                                  })
                                  .mouseout(function() {
                                    a("#master_image_preview").show();
                                    a(".master_image span").text("Main Image");
                                    a("#preview_image img").hide();
                                  });
                            })
                        }
                    }

                    function images_toggle(disp_tog , h, show_all_images) {
                        var show_text = 'Show Assigned Images Only';
                        var hide_text = 'Show All Images';

                        if(show_all_images===true) {
                            a(h).find("li.file").has("img[src$='0.png']").show();
                            a(disp_tog).text(show_text);
                            return false;
                        } else if(show_all_images===false) {
                            a(h).find("li.file").has("img[src$='0.png']").hide();
                            a(disp_tog).text(hide_text);
                            return true;
                        }
                    }

                    function e(g) {
                        a(g).find("li>a").bind("click", function() {
                            if (a(this).parent().hasClass("directory")) {
                                if(a(this).attr("rel")!=='/') {
                                    if (a(this).parent().hasClass("collapsed")) {
                                        a(this).parent("ul").remove();
                                        f(a(this).parent(), a(this).attr("rel"));
                                        a(this).parent().removeClass("collapsed").addClass("expanded")
                                    } else {
                                        a(this).parent().find("ul").slideUp("slow");
                                        a(this).parent().removeClass("expanded").addClass("collapsed")
                                    }
                                }
                                var destination = a(this).attr("rel");
                                destination = destination.substring(0, destination.length - 1);
                                a('#val_subdir').text(destination);
                            }
                            return false
                        })
                    }
                    a(this).html('<ul class="filetree start"><li class="wait">&nbsp;<li></ul>');
                    f(a(this), escape(d.root))
                })
            }
        });
        a("#content_body").on("click", "#fm-bcf", function() {
            var folder = $("#fm-icf").val();
            var token = $("input[name=token]").val();
            var formData = {fm:{'create-dir':folder},token:token};
            var adminFile = $("#val_admin_file").text(); 
            var subdir = '';

            if($("#val_subdir").length) {
                subdir = '&subdir='+$("#val_subdir").text();
            }
            $.ajax({
                url : adminFile+"?_g=filemanager&response=token"+subdir,
                type: "POST",
                data : formData,
                success: function(data, textStatus, jqXHR)
                {
                    $("input[name=token]").val(data);
                    $("div#image.fm-filelist").fileTree({
                        root: "/",
                        script: "./" + adminFile,
                        group: '1',
                        name: 'image',
                        unique: false
                    });
                    $("#fm-icf").val('');
                },
                error: function (jqXHR, textStatus, errorThrown){}
            });
 
    
        });
        a("#content_body").on("click", ".fm-refresh", function() {
            var t = $("#val_admin_file").text();
            $("div#image.fm-filelist").fileTree({
                root: "/",
                script: "./" + t,
                group: '1',
                name: 'image',
                unique: false
            });
        });
        a("input.toggle:hidden").each(function() {
            var c = (a(this).val() == "1") ? "1" : "0";
            var d = document.createElement("img");
            d.src = b + c + ".png";
            if (c == "1") {
                d.alt = d.title = "Disable"
            } else {
                d.alt = d.title = "Enable"
            }
            a(d).addClass("checkbox");
            if (a(this).hasClass("unique")) {
                a(d).addClass("unique")
            }
            a(d).attr("rel", "#" + a(this).attr("id"));
            a(this).after(d)
        }).change(function() {
            switch (a(this).val()) {
                case "1":
                    var d = "1";
                    var e = "Disable";
                    break;
                case "2":
                    var d = "star";
                    var e = "";
                    break;
                default:
                    var d = "0";
                    var e = "Enable";
                    break
            }
            var c = "img.checkbox[rel=#" + a(this).attr("id") + "]";
            a(c).attr({
                src: b + d + ".png",
                alt: e,
                title: e
            })
        });
        a("#content_body").on("click", "img.imgtoggle", function() {
            var d = a(this).data("id");

            if(a('#'+d).length) {
                a('#'+d).remove();
            }
 
            var g = a(this).hasClass("unique");
            var e = document.createElement("input");
            var c = "0";
            if (g) {
                a(e).addClass("unique")
            }
            a(e).addClass("toggle").attr({
                type: "hidden",
                id: d,
                rel: a(this).data("rel"),
                name: a(this).data("name"),
                value: a(this).data("value")
            }).change(function() {
                switch (a(this).val()) {
                    case "1":
                        c = "1";
                        break;
                    case "2":

                        $('.fm-filelist input.toggle:hidden[value="2"]').val('1');
                        
                        var img = $("img.checkbox[src$='star.png']");
                        if(img.length>0) {
                            img.attr("src", img.attr("src").replace("star", "1"));
                        }
                        
                        c = "star";
                        a(this).val(2);
                        if (a("#master_image_preview").exists()) {
                            var i = a(this).closest(".image").find("a").attr("href");
                            a("#master_image_preview").attr("src", i)
                        }
                        break;
                    default:
                        c = "0";
                        break
                }
                var h = "img.checkbox[rel=#" + d + "]";
                a(h).attr({
                    src: b + c + ".png"
                })
            });
            var f = a(this).parent("span.action");
            a(this).before(e);
            a(this).removeClass("imgtoggle").addClass("toggle")
        });
        a("#content_body").on("click", "img.checkbox", function() {
            var e = a(this).attr("rel");
            var c = a(this).parents("div:first").hasClass("fm-filelist");
            var f = a(this).hasClass("unique");
            switch (a(e).val()) {
                case "1":
                    if (f || !c) {
                        var d = "0"
                    } else {
                        a("input[value=2].toggle").each(function() {
                            a("img[rel=" + a(this).attr("rel") + "].checkbox").val("1").change()
                        });
                        var d = "2"
                    }
                    break;
                case "2":
                    var d = "0";
                    break;
                default:
                    if (f) {
                        a("div.unique input.toggle").val("0").change()
                    }
                    var d = "1";
                    break
            }
            a(e).val(d).change()
        })
    })(jQuery)
};